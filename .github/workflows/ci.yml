name: CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format-20
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y clang-format-20

      - name: Check formatting
        run: |
          find src -name '*.cpp' -o -name '*.h' | xargs clang-format-20 --dry-run --Werror

  lint:
    name: Lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy-17

      - name: Run clang-tidy on source files
        run: |
          # Lint our source files with standard checks
          # Note: We can't use automotive-* checks without building LLVM
          find src/automotive -name '*.cpp' | head -10 | xargs clang-tidy-17 \
            --checks='-*,readability-identifier-naming,bugprone-*,modernize-*' \
            -- -std=c++17 -I src 2>&1 || true

  # Optional: Full build job (manual trigger only due to resource requirements)
  build-full:
    name: Full LLVM Build
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch'  # Manual trigger only

    steps:
      - name: Free disk space
        run: |
          # Remove unnecessary packages to free disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker system prune -af
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y clang-20 lld-20 ninja-build

      - name: Download LLVM source
        run: ./download.sh

      - name: Setup symlinks
        run: ./setup.sh

      - name: Configure (optimized for CI)
        run: |
          source version.env
          mkdir -p build
          cd build
          cmake -G Ninja \
            -DCMAKE_CXX_COMPILER=clang++-20 \
            -DCMAKE_C_COMPILER=clang-20 \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" \
            -DLLVM_TARGETS_TO_BUILD="X86" \
            -DLLVM_USE_LINKER=lld-20 \
            -DLLVM_PARALLEL_LINK_JOBS=1 \
            -DLLVM_USE_SPLIT_DWARF=ON \
            -DLLVM_ENABLE_ASSERTIONS=OFF \
            -DLLVM_ENABLE_BACKTRACES=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DCLANG_INCLUDE_TESTS=OFF \
            "../${LLVM_DIR}/llvm"

      - name: Build clang-tidy
        run: |
          cd build
          ninja -j2 clang-tidy

      - name: Test automotive checks
        run: |
          ./build/bin/clang-tidy --checks="automotive-*" --list-checks
          ./build/bin/clang-tidy --checks="automotive-*" test/checkers/automotive/statement/avoid-goto.c -- || true
